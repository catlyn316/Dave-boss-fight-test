-- 基本服務與玩家
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")

-- 自動Loopfb（燈光控制）
local function autoLoopfb()
    spawn(function()
        while wait(0.1) do
            pcall(function()
                local character = LocalPlayer.Character
                if character then
                    local lantern = character:FindFirstChild("Lantern")
                    if lantern then
                        local network = lantern:FindFirstChild("Network")
                        if network then
                            local args = {
                                [1] = "Fb"
                            }
                            network:FireServer(unpack(args))
                        end
                    end
                end
            end)
        end
    end)
end

-- 啟動自動Loopfb
autoLoopfb()

-- GUI 主體
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "MaolingHub"

-- 修正：主框架樣式
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 450, 0, 350)
Frame.Position = UDim2.new(0.5, -225, 0.5, -175)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true

-- 添加漸層效果
local gradient = Instance.new("UIGradient", Frame)
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 25, 35)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(35, 35, 50))
}
gradient.Rotation = 45

-- 添加外發光效果
local stroke = Instance.new("UIStroke", Frame)
stroke.Color = Color3.fromRGB(100, 150, 255)
stroke.Thickness = 2
stroke.Transparency = 0.5

Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 15)

-- 修正：標題樣式
local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1, -80, 0, 50)
Title.Position = UDim2.new(0, 15, 0, 0)  -- 往上移動5像素原為5
Title.BackgroundTransparency = 1
Title.Text = "✨ 貓玲的腳本區 ✨"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextXAlignment = Enum.TextXAlignment.Left

-- 添加標題發光效果
local titleStroke = Instance.new("UIStroke", Title)
titleStroke.Color = Color3.fromRGB(100, 150, 255)
titleStroke.Thickness = 1
titleStroke.Transparency = 0.3

-- 修正：關閉按鈕樣式和功能
local Close = Instance.new("TextButton", Frame)
Close.Size = UDim2.new(0, 35, 0, 35)
Close.Position = UDim2.new(1, -40, 0, 8)
Close.Text = "x"
Close.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
Close.TextColor3 = Color3.fromRGB(255, 255, 255)
Close.Font = Enum.Font.GothamBold
Close.TextSize = 18
Close.BorderSizePixel = 0

-- 添加關閉按鈕效果
local closeGradient = Instance.new("UIGradient", Close)
closeGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(220, 60, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 40, 40))
}

Instance.new("UICorner", Close).CornerRadius = UDim.new(0, 8)

-- 修正：關閉按鈕功能
Close.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    _G.maolingHubLoaded = false -- 重置載入狀態
end)

-- 修正：最小化按鈕樣式
local Minimize = Instance.new("TextButton", Frame)
Minimize.Size = UDim2.new(0, 35, 0, 35)
Minimize.Position = UDim2.new(1, -80, 0, 8)
Minimize.Text = "─"
Minimize.BackgroundColor3 = Color3.fromRGB(100, 100, 120)
Minimize.TextColor3 = Color3.fromRGB(255, 255, 255)
Minimize.Font = Enum.Font.GothamBold
Minimize.TextSize = 16
Minimize.BorderSizePixel = 0

local minimizeGradient = Instance.new("UIGradient", Minimize)
minimizeGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 100, 120)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 100))
}

Instance.new("UICorner", Minimize).CornerRadius = UDim.new(0, 8)

-- 修正：側邊欄為可滾動
local SideBar = Instance.new("ScrollingFrame", Frame)
SideBar.Size = UDim2.new(0, 130, 1, -55)
SideBar.Position = UDim2.new(0, 5, 0, 50)
SideBar.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
SideBar.BorderSizePixel = 0
SideBar.ScrollBarThickness = 6
SideBar.CanvasSize = UDim2.new(0, 0, 0, 200)
SideBar.AutomaticCanvasSize = Enum.AutomaticSize.Y
SideBar.ScrollingDirection = Enum.ScrollingDirection.Y

-- 添加側邊欄樣式
local sidebarGradient = Instance.new("UIGradient", SideBar)
sidebarGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 50)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 45, 65))
}

Instance.new("UICorner", SideBar).CornerRadius = UDim.new(0, 10)

-- 添加UIListLayout到側邊欄
local sidebarLayout = Instance.new("UIListLayout", SideBar)
sidebarLayout.Padding = UDim.new(0, 8)
sidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- 修正：內容區域
local Content = Instance.new("Frame", Frame)
Content.Size = UDim2.new(1, -145, 1, -55)
Content.Position = UDim2.new(0, 140, 0, 50)
Content.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
Content.BorderSizePixel = 0

local contentGradient = Instance.new("UIGradient", Content)
contentGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 75))
}

Instance.new("UICorner", Content).CornerRadius = UDim.new(0, 10)

-- 修正：縮小功能的尺寸
local isMinimized = false
local fullSize = UDim2.new(0, 450, 0, 350)
local miniSize = UDim2.new(0, 450, 0, 50)

Minimize.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    SideBar.Visible = not isMinimized
    Content.Visible = not isMinimized
    Frame.Size = isMinimized and miniSize or fullSize
end)

-- 修正：簡單高亮文字的分區按鈕樣式
local function createSectionButton(text, order, parent)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0, 120, 0, 45)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(85, 85, 105)  -- 比原本更亮的背景
    
    -- 最亮的文字設定
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 純白色
    btn.TextTransparency = 0  -- 完全不透明
    btn.Font = Enum.Font.GothamBold  -- 粗體字
    btn.TextSize = 16  -- 適中大小
    btn.BorderSizePixel = 0
    
    -- 添加圓角
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
    
    -- 簡化描邊
    local btnStroke = Instance.new("UIStroke", btn)
    btnStroke.Color = Color3.fromRGB(150, 180, 255)
    btnStroke.Thickness = 1
    btnStroke.Transparency = 0.6
    
    -- 簡單hover效果
    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(105, 105, 125)  -- hover時更亮
        btnStroke.Transparency = 0.3
    end)
    
    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(85, 85, 105)
        btnStroke.Transparency = 0.6
    end)
    
    return btn
end

-- 修正：簡單高亮文字的一般按鈕樣式
local function createButton(text, order, parent, spacing)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0, 180, 0, 35)
    btn.Position = UDim2.new(0.5, -90, 0, 10 + (order - 1) * spacing)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)  -- 比原本更亮的背景
    
    -- 最亮的文字設定
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 純白色
    btn.TextSize = 16  -- 適中大小
    btn.Font = Enum.Font.GothamBold  -- 粗體字
    btn.BorderSizePixel = 0
    
    -- 添加圓角
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    
    -- 簡化描邊
    local btnStroke = Instance.new("UIStroke", btn)
    btnStroke.Color = Color3.fromRGB(120, 170, 255)
    btnStroke.Thickness = 1
    btnStroke.Transparency = 0.6
    
    -- 簡單hover效果
    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(100, 160, 240)  -- hover時更亮
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 保持純白
        btnStroke.Transparency = 0.3
    end)
    
    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 保持純白
        btnStroke.Transparency = 0.6
    end)
    
    return btn
end

-- 添加滾動框樣式改善
local function styleScrollFrame(scrollFrame)
    scrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 65)
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 150, 255)
    
    local scrollGradient = Instance.new("UIGradient", scrollFrame)
    scrollGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 45, 65)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(55, 55, 80))
    }
    
    Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)
end

-- 邪惡巴西分區
local EvilBrazilButton = createSectionButton("🇧🇷 邪惡巴西", 1, SideBar)

-- 邪惡巴西內容框架
local EvilBrazilContent = Instance.new("ScrollingFrame", Content)
EvilBrazilContent.Size = UDim2.new(1, -10, 1, -10)
EvilBrazilContent.Position = UDim2.new(0, 5, 0, 5)
EvilBrazilContent.CanvasSize = UDim2.new(0, 0, 0, 300)
EvilBrazilContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
EvilBrazilContent.ScrollBarThickness = 6
EvilBrazilContent.Visible = true
styleScrollFrame(EvilBrazilContent)

-- 添加內容區域布局
local contentLayout = Instance.new("UIListLayout", EvilBrazilContent)
contentLayout.Padding = UDim.new(0, 10)
contentLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
contentLayout.VerticalAlignment = Enum.VerticalAlignment.Top

-- 邪惡巴西功能按鈕
-- 1. 傳送到Boss戰
local TeleportToBossBtn = createButton("💀 傳送到Boss戰", 1, EvilBrazilContent, 45)
TeleportToBossBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local targetPortal = Workspace:FindFirstChild("Evil Barzil")
            if targetPortal then
                targetPortal = targetPortal:FindFirstChild("evilbarzil")
                if targetPortal then
                    targetPortal = targetPortal:FindFirstChild("portal")
                    if targetPortal then
                        character.HumanoidRootPart.CFrame = targetPortal.CFrame
                    end
                end
            end
        end
    end)
end)

-- 2. 跳過第一關
local SkipFirstLevelBtn = createButton("⚡ 跳過第一關", 2, EvilBrazilContent, 45)
SkipFirstLevelBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            -- 第一步：傳送到Spotlight
            local spotlight = Workspace:FindFirstChild("Spotlight")
            if spotlight then
                character.HumanoidRootPart.CFrame = spotlight.CFrame
                
                -- 等待0.5秒
                wait(0.5)
                
                -- 第二步：傳送到GateMechanism.Touchpad
                local gateMechanism = Workspace:FindFirstChild("GateMechanism")
                if gateMechanism then
                    local touchpad = gateMechanism:FindFirstChild("Touchpad")
                    if touchpad then
                        character.HumanoidRootPart.CFrame = touchpad.CFrame
                        
                        -- 等待2秒
                        wait(2)
                        
                        -- 第三步：傳送到TheOutside.TowerENT1.teleport
                        local theOutside = Workspace:FindFirstChild("TheOutside")
                        if theOutside then
                            local towerENT1 = theOutside:FindFirstChild("TowerENT1")
                            if towerENT1 then
                                local teleport = towerENT1:FindFirstChild("teleport")
                                if teleport then
                                    character.HumanoidRootPart.CFrame = teleport.CFrame
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end)

-- 3. 解電梯
local UnlockElevatorBtn = createButton("解電梯(好像沒用)", 3, EvilBrazilContent, 45)
UnlockElevatorBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            -- 第一步：傳送到Stepladder並執行ProximityPrompt
            local stepladder = Workspace:FindFirstChild("Stepladder")
            if stepladder then
                character.HumanoidRootPart.CFrame = stepladder.CFrame
                local frame = stepladder:FindFirstChild("Frame")
                if frame then
                    local proximityPrompt = frame:FindFirstChild("ProximityPrompt")
                    if proximityPrompt then
                        fireproximityprompt(proximityPrompt)
                    end
                end
            end
            
            -- 第二步：傳送到Screwdriver並執行ProximityPrompt
            local screwdriver = Workspace:FindFirstChild("Screwdriver")
            if screwdriver then
                character.HumanoidRootPart.CFrame = screwdriver.CFrame
                local proximityPrompt = screwdriver:FindFirstChild("ProximityPrompt")
                if proximityPrompt then
                    fireproximityprompt(proximityPrompt)
                end
            end
            
            -- 第三步：傳送到ElevatorHatch並執行ProximityPrompt
            local openableDoors = Workspace:FindFirstChild("OpenableDoors")
            if openableDoors then
                local elevatorHatch = openableDoors:FindFirstChild("ElevatorHatch")
                if elevatorHatch then
                    character.HumanoidRootPart.CFrame = elevatorHatch.CFrame
                    local promptHolder = elevatorHatch:FindFirstChild("PromptHolder")
                    if promptHolder then
                        local proximityPrompt = promptHolder:FindFirstChild("ProximityPrompt")
                        if proximityPrompt then
                            fireproximityprompt(proximityPrompt)
                        end
                    end
                end
            end
            
            -- 第四步：點擊boltClick
            local clickable = Workspace:FindFirstChild("Clickable")
            if clickable then
                local boltClick = clickable:FindFirstChild("boltClick")
                if boltClick then
                    local clickDetector = boltClick:FindFirstChild("ClickDetector")
                    if clickDetector then
                        fireclickdetector(clickDetector)
                    end
                end
            end
        end
    end)
end)

-- 4. 傳送到骰子 (新增的按鈕)
local TeleportToDiceBtn = createButton("🎲 傳送到骰子(出來電梯後點)", 4, EvilBrazilContent, 45)
TeleportToDiceBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local cursedDice = Workspace:FindFirstChild("Cursed Dice")
            if cursedDice then
                character.HumanoidRootPart.CFrame = cursedDice.CFrame
            else
                print("找不到 Cursed Dice 物件")
            end
        end
    end)
end)

-- 5. 傳送到終點
local TeleportToEndBtn = createButton("🎯 傳送到終點", 5, EvilBrazilContent, 45)
TeleportToEndBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("Humanoid") then
            -- 傳送到終點的第5個子物件
            local diceCatch = Workspace:FindFirstChild("DiceCatch")
            if diceCatch then
                local children = diceCatch:GetChildren()
                if children[5] then
                    character.HumanoidRootPart.CFrame = children[5].CFrame
                end
            end
            
            -- 持續固定玩家速度為50和跳躍力為75
            local humanoid = character.Humanoid
            
            -- 創建連接來持續監控並固定數值
            local speedConnection
            local jumpConnection
            
            speedConnection = humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
                if humanoid.WalkSpeed ~= 50 then
                    humanoid.WalkSpeed = 50
                end
            end)
            
            jumpConnection = humanoid:GetPropertyChangedSignal("JumpPower"):Connect(function()
                if humanoid.JumpPower ~= 75 then
                    humanoid.JumpPower = 75
                end
            end)
            
            -- 初始設定
            humanoid.WalkSpeed = 50
            humanoid.JumpPower = 75
            
            -- 當角色重生時清理連接
            humanoid.Died:Connect(function()
                if speedConnection then speedConnection:Disconnect() end
                if jumpConnection then jumpConnection:Disconnect() end
            end)
            
            -- 在腳下創建平台
            local platform = Instance.new("Part")
            platform.Name = "EndPlatform"
            platform.Size = Vector3.new(5000, 5, 5000)
            platform.Material = Enum.Material.Plastic
            platform.BrickColor = BrickColor.new("Medium stone grey")
            platform.Anchored = true
            platform.CanCollide = true
            
            -- 設定平台位置在玩家腳下
            local playerPosition = character.HumanoidRootPart.Position
            local originalY = playerPosition.Y - 7.5
            platform.Position = Vector3.new(playerPosition.X, originalY, playerPosition.Z)
            
            -- 儲存原始Y位置供後續使用
            platform:SetAttribute("OriginalY", originalY)
            
            platform.Parent = Workspace
        end
    end)
end)

-- 6. 自動拿/放炸彈（可開關）- 自動觸發ProximityPrompt
local AutoBombBtn = createButton("💣 自動拿/放炸彈", 6, EvilBrazilContent, 45)
local isAutoBombOn = false
local autoBombConnection = nil

-- 獲取玩家攝像機
local Camera = game.Workspace.CurrentCamera

-- 自動觸發可見ProximityPrompt的函數
local function autoTriggerProximityPrompts()
    pcall(function()
        local character = LocalPlayer.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then
            return
        end
        
        -- 遞歸查找所有ProximityPrompt
        local function findProximityPrompts(obj)
            local prompts = {}
            
            for _, child in pairs(obj:GetChildren()) do
                if child:IsA("ProximityPrompt") then
                    table.insert(prompts, child)
                end
                
                -- 遞歸查找子物件
                local childPrompts = findProximityPrompts(child)
                for _, prompt in pairs(childPrompts) do
                    table.insert(prompts, prompt)
                end
            end
            
            return prompts
        end
        
        -- 獲取所有ProximityPrompt
        local allPrompts = findProximityPrompts(Workspace)
        
        for _, prompt in pairs(allPrompts) do
            -- 檢查ProximityPrompt是否啟用且父物件存在
            if prompt.Enabled and prompt.Parent then
                local promptPart = prompt.Parent
                
                -- 檢查是否在範圍內
                if promptPart:IsA("BasePart") then
                    local distance = (character.HumanoidRootPart.Position - promptPart.Position).Magnitude
                    
                    -- 如果在觸發範圍內，自動觸發
                    if distance <= prompt.MaxActivationDistance then
                        -- 檢查是否在視角範圍內（簡單的前方檢測）
                        local directionToPrompt = (promptPart.Position - character.HumanoidRootPart.Position).Unit
                        local lookDirection = character.HumanoidRootPart.CFrame.LookVector
                        local dotProduct = directionToPrompt:Dot(lookDirection)
                        
                        -- 如果大致在前方（角度小於90度）
                        if dotProduct > 0 then
                            fireproximityprompt(prompt)
                        end
                    end
                end
            end
        end
    end)
end

AutoBombBtn.MouseButton1Click:Connect(function()
    pcall(function()
        isAutoBombOn = not isAutoBombOn
        
        if isAutoBombOn then
            -- 開啟模式：開始自動觸發ProximityPrompt
            AutoBombBtn.Text = "💣 自動拿/放炸彈 (ON)"
            AutoBombBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
            
            -- 每0.1秒檢查一次
            autoBombConnection = game:GetService("RunService").Heartbeat:Connect(function()
                autoTriggerProximityPrompts()
            end)
            
        else
            -- 關閉模式
            AutoBombBtn.Text = "💣 自動拿/放炸彈"
            AutoBombBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
            
            -- 斷開自動觸發連接
            if autoBombConnection then
                autoBombConnection:Disconnect()
                autoBombConnection = nil
            end
        end
    end)
end)

-- 7. 丟炸彈時用（可開關）- 固定高度5秒後移動到平台
local BombThrowBtn = createButton("💥 丟炸彈時用", 7, EvilBrazilContent, 45)
local isBombThrowOn = false
local bombThrowConnection = nil
local bombPlatform = nil
local heightFixTimer = nil

BombThrowBtn.MouseButton1Click:Connect(function()
    pcall(function()
        local character = LocalPlayer.Character
        
        if character and character:FindFirstChild("HumanoidRootPart") then
            isBombThrowOn = not isBombThrowOn
            
            if isBombThrowOn then
                -- 開啟模式：固定高度5570並創建平台
                BombThrowBtn.Text = "💥 丟炸彈時用 (ON)"
                BombThrowBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
                
                -- 創建平台
                bombPlatform = Instance.new("Part")
                bombPlatform.Name = "BombPlatform"
                bombPlatform.Size = Vector3.new(5000, 5, 5000)
                bombPlatform.Material = Enum.Material.Plastic
                bombPlatform.BrickColor = BrickColor.new("Medium stone grey")
                bombPlatform.Anchored = true
                bombPlatform.CanCollide = true
                
                -- 設定平台位置在高度5570-7.5的位置
                local playerPosition = character.HumanoidRootPart.Position
                bombPlatform.Position = Vector3.new(playerPosition.X, 5570 - 7.5, playerPosition.Z)
                bombPlatform.Parent = Workspace
                
                -- 將玩家傳送到高度5570
                local currentPos = character.HumanoidRootPart.Position
                character.HumanoidRootPart.CFrame = CFrame.new(
                    Vector3.new(currentPos.X, 5570, currentPos.Z),
                    character.HumanoidRootPart.CFrame.LookVector
                )
                
                -- 記錄開始時間和固定狀態
                local startTime = tick()
                local isHeightFixed = true
                
                -- 創建連接來處理高度固定和平台跟隨
                bombThrowConnection = game:GetService("RunService").Heartbeat:Connect(function()
                    if character and character:FindFirstChild("HumanoidRootPart") and character.Parent then
                        local currentTime = tick()
                        local currentPosition = character.HumanoidRootPart.Position
                        
                        -- 前0.5秒固定玩家高度在5570
                        if isHeightFixed and (currentTime - startTime) < 0.5 then
                            if math.abs(currentPosition.Y - 5570) > 0.1 then
                                character.HumanoidRootPart.CFrame = CFrame.new(
                                    Vector3.new(currentPosition.X, 5570, currentPosition.Z),
                                    character.HumanoidRootPart.CFrame.LookVector
                                )
                            end
                        elseif isHeightFixed and (currentTime - startTime) >= 0.5 then
                            -- 0.5秒後解除高度固定，將玩家移動到平台上
                            isHeightFixed = false
                            if bombPlatform and bombPlatform.Parent then
                                local platformTop = bombPlatform.Position.Y + (bombPlatform.Size.Y / 2) + 3
                                character.HumanoidRootPart.CFrame = CFrame.new(
                                    Vector3.new(currentPosition.X, platformTop, currentPosition.Z),
                                    character.HumanoidRootPart.CFrame.LookVector
                                )
                            end
                        end
                        
                        -- 平台始終跟隨玩家XZ位置
                        if bombPlatform and bombPlatform.Parent then
                            local expectedPlatformPos = Vector3.new(currentPosition.X, 5570 - 7.5, currentPosition.Z)
                            if (bombPlatform.Position - expectedPlatformPos).Magnitude > 0.1 then
                                bombPlatform.Position = expectedPlatformPos
                            end
                        end
                    end
                end)
                
            else
                -- 關閉模式
                BombThrowBtn.Text = "💥 丟炸彈時用"
                BombThrowBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
                
                -- 斷開高度固定連接
                if bombThrowConnection then
                    bombThrowConnection:Disconnect()
                    bombThrowConnection = nil
                end
                
                -- 移除平台
                if bombPlatform and bombPlatform.Parent then
                    bombPlatform:Destroy()
                    bombPlatform = nil
                end
            end
        end
    end)
end)
game.Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        if autoBombConnection then
            autoBombConnection:Disconnect()
            autoBombConnection = nil
        end
    end
end)

LocalPlayer.CharacterRemoving:Connect(function()
    if autoBombConnection then
        autoBombConnection:Disconnect()
        autoBombConnection = nil
    end
    -- 重置状态变量
    isAutoBombOn = false
    AutoBombBtn.Text = "💣 自動拿/放炸彈"
    AutoBombBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
end)

-- 8. 自動打釘子（可開關）
local AutoNailBtn = createButton("🔨 自動打釘子", 8, EvilBrazilContent, 45)
local isAutoNailOn = false
local autoNailConnection = nil

-- 自動打釘子函數
local function autoHitNails()
    pcall(function()
        local character = LocalPlayer.Character
        if not character or not character:FindFirstChild("Lantern") then
            return
        end
        
        local lantern = character.Lantern
        local network = lantern:FindFirstChild("Network")
        if not network then
            return
        end
        
        local bossStorage = Workspace:FindFirstChild("bossStorage")
        if not bossStorage then
            return
        end
        
        -- 獲取所有名為"nail"的子物件
        for _, child in pairs(bossStorage:GetChildren()) do
            if child.Name == "nail" then
                local nailObject = child:FindFirstChild("object")
                if nailObject then
                    -- 執行第一個FireServer
                    local args1 = {
                        [1] = "Hit",
                        [2] = nailObject
                    }
                    network:FireServer(unpack(args1))
                    
                    -- 執行第二個FireServer
                    local replicatedStorage = game:GetService("ReplicatedStorage")
                    local remotes = replicatedStorage:FindFirstChild("Remotes")
                    if remotes then
                        local nailHit = remotes:FindFirstChild("NailHit")
                        if nailHit then
                            local args2 = {
                                [1] = nailObject
                            }
                            nailHit:FireServer(unpack(args2))
                        end
                    end
                end
            end
        end
    end)
end

AutoNailBtn.MouseButton1Click:Connect(function()
    pcall(function()
        isAutoNailOn = not isAutoNailOn
        
        if isAutoNailOn then
            -- 開啟模式：開始自動打釘子
            AutoNailBtn.Text = "🔨 自動打釘子 (ON)"
            AutoNailBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
            
            -- 每0.1秒檢查一次
            autoNailConnection = game:GetService("RunService").Heartbeat:Connect(function()
                autoHitNails()
            end)
            
        else
            -- 關閉模式
            AutoNailBtn.Text = "🔨 自動打釘子"
            AutoNailBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
            
            -- 斷開自動打釘子連接
            if autoNailConnection then
                autoNailConnection:Disconnect()
                autoNailConnection = nil
            end
        end
    end)
end)

game.Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        if autoBombConnection then
            autoBombConnection:Disconnect()
            autoBombConnection = nil
        end
        if autoNailConnection then
            autoNailConnection:Disconnect()
            autoNailConnection = nil
        end
    end
end)


-- 分區切換功能
local currentContent = nil

local function showContent(content)
    if currentContent then
        currentContent.Visible = false
    end
    content.Visible = true
    currentContent = content
end

-- 邪惡巴西按鈕點擊事件
EvilBrazilButton.MouseButton1Click:Connect(function()
    showContent(EvilBrazilContent)
end)
